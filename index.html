<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ปฏิทินจองรถ Cm2">
    <meta name="keywords" content="CalenderBookcarCm2">
    <meta name="author" content="นาย ภาคภูมิ เรือนมูล">
    <title>ปฏิทินจองรถ</title>
   <link rel="shortcut icon" href="https://pngimg.com/d/porsche_PNG10622.png" sizes="16x16 32x32 64x64" />
    <link rel="apple-touch-icon" href="https://pngimg.com/d/porsche_PNG10622.png" sizes="180x180" />
  
    
  
    <!-- Tailwind CSS CDN -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

 
    <!-- FullCalendar CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />
    <!-- Fonts -->
<!--     <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet"> -->
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  
   <!-- LineSeed Fonts -->
  <link href="https://cdn.jsdelivr.net/gh/maketline/goodday/font/stylesheet.min.css" rel="stylesheet">
  
    <style>
         body {
      font-family: "line_seed_sans_th", sans-serif;
      font-weight: bold;
      font-size: 12px;
      background-color: #f8f9fa;
    }
        .fc-sat, .fc-sun {
            color: red;
        }
        .color-box1 { background-color: yellow; }
        .color-box2 { background-color: green; }
        .color-box3 { background-color: blue; }
        .modal {
            z-index: 1050; /* ให้ modal อยู่บนสุด */
        }
      #container3 {
          display: flex;
        text-align: center;
      }
      .color-box1 {
          background-color: yellow; /* สีพื้นหลังของกล่อง */
          padding: 10px;
          text-align: center;
          height:10px;
          border-radius: 20px;

      }
       .color-box2 {
          background-color: green; /* สีพื้นหลังของกล่อง */
          padding: 10px;
          text-align: center;
          height:10px;
          border-radius: 20px;
      }
      .color-box3 {
          background-color: blue; /* สีพื้นหลังของกล่อง */
          padding: 10px;
          text-align: center;
          height:10px;
          border-radius: 20px;
      }
       .color-box4 {
          background-color: brown; /* สีพื้นหลังของกล่อง */
          padding: 10px;
          text-align: center;
          height:10px;
          border-radius: 20px;
      }
  #modal {
      z-index: 1000;
   
    }
      
         #modal .modal-header {
      background-color: #3b82f6;
      color: white;
      padding: 1rem;
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
  
   #modal .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      font-size: 15px;
    }

   #modal .modal-footer {
     background-color: #3b82f6;
      color: white;
      padding: 1rem;
      border-bottom-left-radius: 0.5rem;
      border-bottom-right-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

         #modal .relative {
  width: 90%;
  max-width: 700px; /* ปรับค่าเริ่มต้นให้กว้างขึ้น */
  margin: 0 auto;
  box-sizing: border-box;
}

@media (min-width: 768px) {
  #modal .relative {
    max-width: 700px; /* ขยายเพิ่มสำหรับแท็บเล็ต */
  }
}

@media (min-width: 1024px) {
  #modal .relative {
    max-width: 700px; /* ขยายเพิ่มสำหรับเดสก์ท็อป */
  }
}

    #footer {
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
      
     .footer {
    font-size: 0.75rem; /* 12px */
    color: #6b7280; /* text-gray-500 */
    margin-top: 1.5rem; /* mt-6 */
    text-align: center; /* text-center */
} 


.swal-resize {
    height: 155px !important;
    width: auto !important;
    max-width: 200px;
    padding: 0px;
    border-radius: 1.25rem; /* ขอบโค้งมน */
    background-color: #ffffff; /* สีพื้นหลัง */
    box-shadow: 
        0 6px 10px rgba(0, 0, 0, 0.1), /* เงาเบื้องหลัง */
        0 2px 4px rgba(0, 0, 0, 0.08), /* เงาใกล้เคียง */
        inset 0 -3px 5px rgba(0, 0, 0, 0.05), /* เงาด้านใน (ฐาน) */
        inset 0 3px 5px rgba(255, 255, 255, 0.8); /* แสงสะท้อนด้านบน */
    transition: box-shadow 0.3s ease, transform 0.2s ease; /* แอนิเมชัน */
}

  .swal-custom {
    display: flex;
    flex-direction: column;
    align-items: center; /* จัดกึ่งกลางข้อความ */
  }

    </style>
</head>
<body>

   
   <!-- Modal เพิ่มข้อมูล -->
 <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">

    <div class="relative top-5 mx-auto p-0 border w-96 shadow-lg rounded-md bg-white">
      <!-- Header -->
      <div class="bg-blue-500 text-white p-4 rounded-t-md modal-header">
        <h3 class="text-lg leading-6 font-medium">เพิ่มข้อมูล</h3>
      </div>
      <!-- Body -->
      <div class="p-4 modal-body">
   <form id="bookmyForm" method="POST" onsubmit="booksubmitForm(); return false;">
  <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-4">
     
         <!-- วันที่ออก และ วันที่เข้า -->
    <div class="form-group">
        <label class="block text-sm font-medium text-gray-700">วันที่ออก</label>
        <input type="date" id="namestartDate" name="namestartDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 text-blue-600" required>
    </div>
    <div class="form-group">
        <label class="block text-sm font-medium text-gray-700">วันที่เข้า</label>
        <input type="date" id="nameendDate" name="nameendDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 text-blue-600" required>
    </div>
     
     
<!-- ชื่อผู้จอง -->
<div class="form-group">
  <label class="block text-sm font-medium text-gray-700">ชื่อผู้จอง</label>
  <input type="text" id="namebook" name="namebook" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 text-blue-600" list="user-list" required>
  <datalist id="user-list"></datalist>
</div>

    <!-- แผนก -->
    <div class="form-group">
        <label class="block text-sm font-medium text-gray-700">แผนก</label>
        <select id="namedep" name="namedep" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 text-blue-600 pointer-events-none" required>
                <option value=''></option>
                    <option value="PC">PC</option>
                    <option value="HR">HR</option>
                    <option value="FN">FN</option>
                    <option value="AC">AC</option>
                    <option value="O&E">O&E</option>
                    <option value="LAB">LAB</option>
                    <option value="SF">SF</option>
                    <option value="ST">ST</option>
                    <option value="MC">MC</option>
                    <option value="PR">PR</option>
                    <option value="QC">QC</option>
                    <option value="PA">PA</option>
                    <option value="IT">IT</option>
                    <option value="DC">DC</option>
                    <option value="RM">RM</option>
                    <option value="EC">EC</option>
                    <option value="AP">AP</option>
                    <option value="R&D">R&D</option>
        </select>
    </div>

 <!-- เลือกรถ -->
<div class="form-group">
  <label class="block text-sm font-medium text-gray-700">เลือกรถ</label>
  <select id="namecar" name="namecar" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 text-blue-600" required>
    <option value="">-- เลือกรถ --</option>
  </select>
</div>
     
      <!-- สถานะการขับ -->
    <div class="form-group">
        <label class="block text-sm font-medium text-gray-700">สถานะการขับ</label>
        <select id="namedrivestatus" name="namedrivestatus" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 text-blue-600" required>
            <option value=""></option>
            <option value="ขับเอง">ขับเอง</option>
            <option value="พร้อมคนขับ">พร้อมคนขับ</option>
        </select>
    </div>
    
      <!-- เวลาออก และ เวลาเข้า -->
    <div class="form-group">
        <label class="block text-sm font-medium text-gray-700">เวลาออก</label>
        <select id="namestartTime" name="namestartTime" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 text-blue-600" required>
            <option value="">-- เลือกเวลาออก --</option>
            <script>
                for (var hour = 5; hour <= 23; hour++) {
                    for (var minute = 0; minute <= 45; minute += 15) {
                        var formattedHour = ('0' + hour).slice(-2);
                        var formattedMinute = ('0' + minute).slice(-2);
                        document.write('<option value="' + formattedHour + ':' + formattedMinute + '">' + formattedHour + ':' + formattedMinute + '</option>');
                    }
                }
            </script>
        </select>
    </div>
    <div class="form-group">
        <label class="block text-sm font-medium text-gray-700">เวลาเข้า</label>
        <select id="nameendTime" name="nameendTime" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 text-blue-600" required>
            <option value="">-- เลือกเวลาเข้า --</option>
            <script>
                for (var hour = 8; hour <= 23; hour++) {
                    for (var minute = 1; minute <= 46; minute += 15) {
                        var formattedHour = ('0' + hour).slice(-2);
                        var formattedMinute = ('0' + minute).slice(-2);
                        document.write('<option value="' + formattedHour + ':' + formattedMinute + '">' + formattedHour + ':' + formattedMinute + '</option>');
                    }
                }
            </script>
        </select>
    </div>

    <!-- สถานที่ๆไปติดต่อ -->
    <div class="form-group col-span-2 sm:col-span-2">
        <label class="block text-sm font-medium text-gray-700">สถานที่ๆไปติดต่อ</label>
        <input type="text" id="nameloca" name="nameloca" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 text-blue-600" required>
    </div>



  

   <input type="hidden" name="referer" id="referer">

    <!-- อื่นๆ -->
    <div class="form-group col-span-2 sm:col-span-2">
        <label class="block text-sm font-medium text-gray-700">อื่นๆ</label>
        <input type="text" id="nameother" name="nameother" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300 text-blue-600">
    </div>


      </div>
     
       </form>
        </div>
      <!-- Footer -->
      <div class="bg-blue-500 p-4 rounded-b-md modal-footer">
        <div class="flex justify-end gap-2">
          <button type="submit"  onclick="booksubmitForm()" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">บันทึก</button>
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">ปิด</button>
        </div>
      </div>
     
    

  
  </div>
</div>

  
<section id="page1" style="display: none;" class="min-h-screen flex items-center justify-center bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-lg shadow-lg">
        <div>
            <h2 class="text-center text-3xl font-extrabold text-gray-900">CarBook</h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                กรุณาเข้าสู่ระบบเพื่อใช้งาน
            </p>
        </div>
        <form id="loginForm" method="POST" onsubmit="loginForm(); return false;" class="mt-8 space-y-6">
            <div class="rounded-md shadow-sm">
                <div>
                    <label for="username" class="sr-only">Username</label>
                    <input 
                        id="username" 
                        name="username" 
                        type="text" 
                        required 
                        class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" 
                        placeholder="Username"
                    >
                </div>
                <br>
                <div class="relative">
                    <label for="password" class="sr-only">Password</label>
                    <input 
                        id="password" 
                        name="password" 
                        type="password" 
                       
                        maxlength="10" 
                        required 
                        class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm pr-10" 
                        placeholder="Password"
                    >
                    <!-- ไอคอนแสดง/ซ่อนรหัสผ่าน -->
                    <span id="togglePassword" class="absolute inset-y-0 right-3 flex items-center cursor-pointer">
                        <i class="fas fa-eye text-gray-500"></i>
                    </span>
                </div>
            </div>

            <div>
                <button 
                    type="submit" 
                    class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                    Login
                </button>
            </div>
        </form>
        <div class="text-center">
            <p class="text-sm text-red-600">
                ใช้ Username และ password เดิมของท่าน<br>เมื่อเข้าสู่ระบบแล้วสามารถกดตรงวันที่เพื่อจองรถได้เลย
<!--                 <a href="##" data-bs-toggle="modal" data-bs-target="#myModal" class="font-medium text-blue-600 hover:text-blue-500">
                    ลงทะเบียนที่นี่
                </a> -->
            </p>
        </div>
    </div>
</section>
  
  
   <section id="page2" style="display: none;">
  <div id="calendarpage" class="container-fluid mt-4 px-4" style="display:none;">
    <div class="bg-gray-100 shadow-lg rounded-lg overflow-hidden">
      <div class="bg-green-500 text-white py-3 px-6 flex justify-between items-center">
    <h5 class="text-lg font-semibold">ปฏิทินจองรถ</h5>
 <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition duration-300">
    Log out
</button>
</div>
   
        <!-- Body -->
        <div class="p-1">
            <div id="calendar" class="bg-gray-100 p-2 rounded-lg"></div><br>
            <!-- Legend -->
            <div id="container3" class="flex items-center space-x-4">
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-yellow-500 rounded-sm"></div>
                    <p class="ml-2 text-sm text-gray-600">= รออนุมัติ</p>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-green-500 rounded-sm"></div>
                    <p class="ml-2 text-sm text-gray-600">= อนุมัติ</p>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-blue-500 rounded-sm"></div>
                    <p class="ml-2 text-sm text-gray-600">= เสร็จงาน</p>
                </div>
            <div class="w-4 h-4 rounded-sm" style="background-color: #8B4513;"></div>
<p class="ml-2 text-sm text-gray-600">= จองหลายวัน</p>
            </div>
        
           
        </div>
   
    
     <div class="bg-green-500 text-white text-center py-3 px-6">
            <h6 class="text-lg font-semibold" style="font-size: 15px;"> <i class="far fa-copyright"></i> พัฒนาโดย นาย ภาคภูมิ เรือนมูล Hr Support</h6>
        
        </div>
    </div> 
</div>

</section>

  <br>

  

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <script>

//         // เรียก fetchNames() ทันทีเมื่อ login สำเร็จ
// window.onload = fetchNames;

        
       window.onload = function() {
        document.getElementById('referer').value = window.location.hostname;
           fetchNames();
    };
      
           

        
function fetchNames() {
  // ดึงค่า statuslogin จาก localStorage
  const statusLogin = localStorage.getItem("statuslogin");

  // เรียก Google Apps Script เพื่อดึงข้อมูล
  fetch('https://script.google.com/macros/s/AKfycbyyhPanSdQPBRFx5QpCbNtJm4WYRdhumqsVQqxHwFMh4j42L2fMCnCOcD8uoU42cs0C/exec')
    .then(response => response.json())
    .then(data => {
      const carSelect = document.getElementById('namecar');  // <select>
      const userDatalist = document.getElementById('user-list'); // <datalist>

      // ล้างข้อมูลเดิม
      carSelect.innerHTML = '<option value="">-- เลือกรถ --</option>';
      userDatalist.innerHTML = '';

      // กำหนดทะเบียนรถตามสิทธิ์
      let allowedCars = getAllowedCars(statusLogin);

      // กรองเฉพาะทะเบียนรถที่มีสิทธิ์แสดง
      const filteredCars = data.cars.filter(item => allowedCars.includes(item.value));

      // ✅ ใช้ filteredCars แทน data.cars เพื่อให้แสดงเฉพาะรายการที่มีสิทธิ์
      filteredCars.forEach(item => {
        const option = document.createElement('option');
        option.value = item.value;
        option.textContent = item.text;
        carSelect.appendChild(option);
      });

      // เพิ่มข้อมูลใน <datalist> ของชื่อผู้ใช้
      data.users.forEach(item => {
        const option = document.createElement('option');
        option.value = item.value;
        option.textContent = item.text;
        userDatalist.appendChild(option);
      });
    })
    .catch(error => console.error('Error fetching data:', error));
}

// ฟังก์ชันกำหนดทะเบียนรถตามสิทธิ์
function getAllowedCars(statusLogin) {
  if (statusLogin === "admin") {
    return ["No.9", "รถตู้", "Fortuner", "แคมรี่ขาว", "แคมรี่ดำ", "ฝากงาน", "ติดรถไปติดต่องานด้วย"];
  } else if (statusLogin === "user") {
    return ["No.9", "ฝากงาน", "ติดรถไปติดต่องานด้วย"];
  }
  return [];
}




      
       var googleScriptUrl = 'https://script.google.com/macros/s/AKfycbxVVUfSwT1cSTb2oZWo0wXVHthaSIW7L0RD22sNMpHv6tSbqsEpn0hmODDmrf0siKVG/exec'; 
      var googleScriptUrlbook = 'https://script.google.com/macros/s/AKfycbyyhPanSdQPBRFx5QpCbNtJm4WYRdhumqsVQqxHwFMh4j42L2fMCnCOcD8uoU42cs0C/exec'; 
      
         document.getElementById('togglePassword').addEventListener('click', function () {
        const passwordField = document.getElementById('password');
        const icon = this.querySelector('i');

        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordField.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });
      
      
      
      // ตรวจสอบ localStorage เมื่อหน้าเว็บโหลด
document.addEventListener('DOMContentLoaded', function () {
    var storedStatuslogin = localStorage.getItem('statuslogin');
    var storedFnamelogin = localStorage.getItem('fnamelogin');
    var storedDeplogin = localStorage.getItem('deplogin');

    if (storedStatuslogin === 'admin' && storedFnamelogin && storedDeplogin || storedStatuslogin === 'user2' && storedFnamelogin && storedDeplogin ) {
        // ถ้ามีข้อมูลการล็อกอินใน localStorage
        document.getElementById('page1').style.display = 'none'; // ซ่อน page1
        document.getElementById('page2').style.display = 'block'; // แสดง page2
        $('#namebook').val(storedFnamelogin);
        $('#namedep').val(storedDeplogin);
        // $("#namebook").addClass("pointer-events-none bg-gray-100 text-gray-500 cursor-not-allowed");
        // $("#namedep").addClass("pointer-events-none bg-gray-100 text-gray-500 cursor-not-allowed");
      $("#namebook").removeClass("pointer-events-none");
      $("#namedep").removeClass("pointer-events-none");
    } else if (storedStatuslogin === 'user' && storedFnamelogin && storedDeplogin) {
        // ถ้ามีข้อมูลการล็อกอินใน localStorage
        document.getElementById('page1').style.display = 'none'; // ซ่อน page1
        document.getElementById('page2').style.display = 'block'; // แสดง page2
        $('#namebook').val(storedFnamelogin);
        $('#namedep').val(storedDeplogin);
       // $('#vancar').hide();
       // $('#camryblack').hide();
       // $('#camrywhite').hide();
       // $('#fortuner').hide();
        // $("#namebook").addClass("pointer-events-none bg-gray-100 text-gray-500 cursor-not-allowed");
        // $("#namedep").addClass("pointer-events-none bg-gray-100 text-gray-500 cursor-not-allowed");
      $("#namebook").addClass("pointer-events-none");
      $("#namedep").addClass("pointer-events-none");
    } else {
        // ถ้าไม่มีข้อมูลการล็อกอินใน localStorage
        document.getElementById('page1').style.display = 'flex'; // แสดง page1
        document.getElementById('page2').style.display = 'none'; // ซ่อน page2
    }
});

// ฟังก์ชัน loginForm
function loginForm() {
    event.preventDefault();
    Swal.fire({
        position: 'center',
        title: '<h4>กำลังตรวจสอบข้อมูล...</h4>',
        showConfirmButton: false,
    });
    Swal.showLoading();

    var checkusername = document.getElementById('username').value;
    var checkpassword = document.getElementById('password').value;

    if (checkusername == "") {
        Swal.fire({
            position: 'center',
            icon: 'error',
            title: '<h4>กรุณากรอกUsernameของท่าน</h4>',
            showConfirmButton: true,
            confirmButtonText: 'OK',
        });
        return;
    } else if (checkpassword == "") {
        Swal.fire({
            position: 'center',
            icon: 'error',
            title: '<h4>กรุณากรอกPasswordของท่าน</h4>',
            showConfirmButton: true,
            confirmButtonText: 'OK',
        });
        return;
    }

    var formData = new FormData(document.getElementById("loginForm"));
    formData.append('action', 'loginhtml'); // เพิ่ม key "action" เพื่อบ่งบอกว่าเป็นการ loginhtml

    fetch(googleScriptUrl, {
        method: 'POST',
        body: formData
    })
        .then(response => response.json()) // แปลง response เป็น JSON
        .then(data => {
            if (data !== false) {
                var usernamelogin = data.usernamelogin;
                var passwordlogin = data.passwordlogin;
                var fnamelogin = data.namelogin;
                var deplogin = data.deplogin;
                var statuslogin = data.statuslogin;
                if (statuslogin === 'admin' || statuslogin === 'user2') {
                    localStorage.setItem('statuslogin', statuslogin);
                    localStorage.setItem('fnamelogin', fnamelogin);
                    localStorage.setItem('deplogin', deplogin);
                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: '<h4>ยินดีต้อนรับ<br>คุณ ' + fnamelogin + '</h4>',
                        showConfirmButton: false,
                        timer: 1500,
                    });
                    document.getElementById('page1').style.display = 'none'; // ซ่อน page1
                    document.getElementById('page2').style.display = 'block'; // แสดง page2
                    $('#namebook').val(fnamelogin);
                    $('#namedep').val(deplogin);
                    // $("#namebook").addClass("pointer-events-none bg-gray-100 text-gray-500 cursor-not-allowed");
                    // $("#namedep").addClass("pointer-events-none bg-gray-100 text-gray-500 cursor-not-allowed");
                    $("#namebook").removeClass("pointer-events-none");
                    $("#namedep").removeClass("pointer-events-none");
                } else if (statuslogin === 'user') {
                    localStorage.setItem('statuslogin', statuslogin);
                    localStorage.setItem('fnamelogin', fnamelogin);
                    localStorage.setItem('deplogin', deplogin);
                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: '<h4>ยินดีต้อนรับ<br>คุณ ' + fnamelogin + '</h4>',
                        showConfirmButton: false,
                        timer: 1500,
                    });
                    document.getElementById('page1').style.display = 'none'; // ซ่อน page1
                    document.getElementById('page2').style.display = 'block'; // แสดง page2
                    $('#namebook').val(fnamelogin);
                    $('#namedep').val(deplogin);
                    // $("#namebook").addClass("pointer-events-none bg-gray-100 text-gray-500 cursor-not-allowed");
                    // $("#namedep").addClass("pointer-events-none bg-gray-100 text-gray-500 cursor-not-allowed");
                    $('#vancar').hide();
                    $('#camryblack').hide();
                    $('#camrywhite').hide();
                    $('#fortuner').hide();
                    $("#namebook").addClass("pointer-events-none");
                    $("#namedep").addClass("pointer-events-none");
                }
               fetchNames();
            } else {
                Swal.fire({
                    position: 'center',
                    icon: 'error',
                    title: '<h4>ไม่พบข้อมูลที่ท่านกรอกในระบบ</h4>',
                    showConfirmButton: true,
                    confirmButtonText: 'กดปิด',
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                position: 'center',
                icon: 'error',
                title: '<h4>มีข้อผิดพลาดเกิดขึ้น</h4>',
                showConfirmButton: true,
                confirmButtonText: 'กดปิด',
            });
        });
}


// ฟังก์ชัน logout
function logout() {
    Swal.fire({
        title: 'คุณต้องการออกจากระบบหรือไม่?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'ต้องการ!',
        cancelButtonText: 'ยกเลิก'
    }).then((result) => {
        if (result.isConfirmed) {
            localStorage.clear(); // ล้างข้อมูลใน localStorage
            document.getElementById('loginForm').reset(); // รีเซ็ตฟอร์ม
            document.getElementById('page1').style.display = 'flex'; // แสดง page1
            document.getElementById('page2').style.display = 'none'; // ซ่อน page2
          location.reload();
        }
    });
}
      
      

      
      
   var googleScriptUrlCalendar = 'https://script.google.com/macros/s/AKfycbyxIh7eFd4n3ENXiIV0N3EM3prNfOakTInlhehMrmQdL9K1zzoaa5Y5UYnCli66HHou/exec'; 
     
function updateCalendar() {
  const storedStatuslogin = localStorage.getItem('statuslogin');
  const storedFnamelogin = localStorage.getItem('fnamelogin');
  const storedDeplogin = localStorage.getItem('deplogin');

  // เช็คว่ามีข้อมูล login หรือไม่
  if (storedStatuslogin && storedFnamelogin && storedDeplogin) {
    lodingpagetoday(); // แสดงหน้าโหลดถ้ามีข้อมูล login
  }

  const cachedData = getCachedData();
  if (cachedData) {
    renderData(cachedData); // แสดงข้อมูล Cache ทันที
  }

  $.ajax({
    url: googleScriptUrlCalendar + '?t=' + Date.now(), // ป้องกัน cache browser
    dataType: 'json',
    success: function(data) {
      setCachedData(data); // อัปเดต Cache
      if (!deepCompare(data, cachedData)) { // ตรวจสอบการเปลี่ยนแปลงข้อมูล
        renderData(data); // อัปเดตเมื่อข้อมูลเปลี่ยน
      }
      Swal.close();
      $("#calendarpage").show();
    },
    error: function() {
      Swal.close();
      alert('เกิดข้อผิดพลาดในการโหลดข้อมูล');
    }
  });
}



// ฟังก์ชันจัดการ Cache
function getCachedData() {
  const cache = localStorage.getItem('calendarCache');
  if (!cache) return null;
  
  const { data } = JSON.parse(cache);
  
  return data; // คืนข้อมูลจาก Cache โดยไม่สนใจอายุ
}

function setCachedData(data) {
  const cache = {
    data: data,
    timestamp: Date.now() // เก็บเวลาปัจจุบันเพื่อใช้อ้างอิงในอนาคต
  };
  localStorage.setItem('calendarCache', JSON.stringify(cache));
}


// ฟังก์ชันตรวจสอบการเปลี่ยนแปลงข้อมูล
function deepCompare(a, b) {
  return JSON.stringify(a) === JSON.stringify(b);
}

        // ฟังก์ชันแสดงปฏิทิน
function renderData(data) {
    const cmthaiHolidays = [
        { title: "วันปีใหม่", date: "2025-01-01" },
        { title: "วันมาฆบูชา", date: "2025-02-12" },
        { title: "วันสงกรานต์", date: "2025-04-12" },
        { title: "วันสงกรานต์", date: "2025-04-13" },
        { title: "วันสงกรานต์", date: "2025-04-14" },
        { title: "วันสงกรานต์", date: "2025-04-15" },
        { title: "วันสงกรานต์", date: "2025-04-16" },
        { title: "หยุดชดเชยวันสงกรานต์", date: "2025-04-17" },
        { title: "วันแรงงาน", date: "2025-05-01" },
        { title: "วันเฉลิมราชินีรัชกาลที่10", date: "2025-06-03" },
        { title: "วันอาสาฬหบูชา", date: "2025-07-10" },
        { title: "วันพระบรมราชสมภพรัชกาลที่10", date: "2025-07-28" },
        { title: "วันแม่แห่งชาติ", date: "2025-08-12" },
        { title: "วันพ่อแห่งชาติ", date: "2025-12-05" },
        { title: "วันสิ้นปี", date: "2025-12-31" }
    ];

    const cmHolidays = cmthaiHolidays.map(holiday => ({
        title: holiday.title,
        start: holiday.date,
        allDay: true,
        backgroundColor: "#e51c23",
        borderColor: "#e11d48",
        textColor: "#ffffff",
        isHolidaycm: true,
        order: 2 // ลำดับต่ำสุดสำหรับวันหยุด
    }));

    $('#calendar').fullCalendar('destroy');
    $('#calendar').fullCalendar({
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month'
        },
        height: 'auto',
        editable: false,
        timezone: 'local',
        locale: 'th',
        nextDayThreshold: '00:00:00',
        dayNamesShort: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'],
        showNonCurrentDates: false,
        eventOrder: 'order', // จัดลำดับอีเว้นท์ตามคุณสมบัติ order
        events: [
            ...data.map(event => {
                const startDate = moment(event.startday, 'YYYY-MM-DD');
                const endDate = moment(event.endday, 'YYYY-MM-DD');
                const daysDiff = endDate.diff(startDate, 'days');

                const dailyEvents = [];
                for (let i = 0; i <= daysDiff; i++) {
                    const currentDate = startDate.clone().add(i, 'days');
                    dailyEvents.push({
                        id: event.id + '_' + i,
                        title: event.title,
                        start: currentDate.format('YYYY-MM-DD'),
                        allDay: true,
                        status: event.status,
                        starttime: event.starttime,
                        endtime: event.endtime,
                        namebook: event.namebook,
                        loca: event.loca,
                        dep: event.dep,
                        other: event.other,
                        driver: event.driver,
                        approve: event.approve,
                        isMultiDay: daysDiff > 0,
                        dayNumber: i + 1,
                        totalDays: daysDiff + 1,
                        order: daysDiff > 0 ? 0 : 1 // อีเว้นท์หลายวัน (order: 0) อยู่ด้านบน, อีเว้นท์วันเดียว (order: 1)
                    });
                }
                return dailyEvents;
            }).flat(),
            ...cmHolidays
        ],
        eventRender: function(event, element) {
            element.find('.fc-time').hide();
            if (event.isHolidaycm) {
                element.find('.fc-title').html(`<div style="text-align:center;">${event.title}<br>Cmหยุด</div>`);
            } else {
                let timeText = '';
                if (event.isMultiDay) {
                    if (event.dayNumber === 1) {
                        timeText = `ออก ${event.starttime}`;
                        dateInfo = `เริ่ม: ${moment(event.start).format('DD/MM/YYYY')}`;
                    } else if (event.dayNumber === event.totalDays) {
                        timeText = `เข้า ${event.endtime}`;
                        dateInfo = `สิ้นสุด: ${moment(event.start).format('DD/MM/YYYY')}`;
                    } else {
                        timeText = `${event.starttime} - ${event.endtime}`;
                    }
                } else {
                    timeText = `${event.starttime} - ${event.endtime}`;
                }

                element.find('.fc-title').html(`
                    <div style="text-align:center; cursor: pointer;font-size: 10px;">
                        ${event.title}<br>${timeText}
                    </div>
                `);
            }

            // กำหนดสีตามสถานะ
            if (event.status === 'รออนุมัติ') {
                element.css({ 
                    'background-color': '#facc15', // สีเหลืองสำหรับรออนุมัติ (ทั้งหลายวันและวันเดียว)
                    'border-radius': '5px', 
                    'padding': '1px' 
                });
                element.find('.fc-title').css('color', '#1f2937');
            } else if (event.status === 'อนุมัติ') {
                element.css({ 
                    'background-color': event.isMultiDay ? '#8B4513' : '#16a34a', // น้ำตาลสำหรับหลายวัน, เขียวสำหรับวันเดียว
                    'border-radius': '5px', 
                    'padding': '1px' 
                });
                element.find('.fc-title').css('color', '#ffffff');
            } else if (event.status === 'ส่งคืน') {
                element.css({ 
                    'background-color': '#3b82f6', 
                    'border-radius': '5px', 
                    'padding': '1px' 
                });
                element.find('.fc-title').css('color', '#ffffff');
            } else if (event.status === 'กำลังใช้งาน') {
                element.css({ 
                    'background-color': '#ef4444', 
                    'border-radius': '5px', 
                    'padding': '1px' 
                });
                element.find('.fc-title').html(`
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%;">
                        <i class="fas fa-car-side fa-shake"></i> 
                        <span>${event.status} ${event.title}</span>
                        <span>${event.starttime} - ${event.endtime}</span>
                    </div>
                `);
            }
        },
        dayRender: function(date, cell) {
            const today = moment().format('YYYY-MM-DD');
            if (date.format('YYYY-MM-DD') === today) {
                cell.css({
                    'background-color': '#FFDEAD',
                    'border-radius': '5px'
                });
            }
        },
        eventClick: function(event) {
            showDateOptions(event.start.format('YYYY-MM-DD'));
        },
        dayClick: function(date) {
            showDateOptions(date.format('YYYY-MM-DD'));
        }
    });
    cachedEventsData = data;
}

function lodingpagetoday() {
  Swal.fire({
    position: 'center',
    html: `
      <div class="swal-custom">
        <img src="https://cdn-icons-png.flaticon.com/512/189/189792.png" class="animate-spin" width="40" style="margin-top:20px;">
        <h6 style="font-size:15px; margin-top:20px; font-weight: bold;">กำลังอัปเดตข้อมูล...</h6>
      </div>`,
    showConfirmButton: false,
    allowOutsideClick: false,
    customClass: {
      popup: 'swal-resize' // ใช้ custom class เพื่อลดขนาด SweetAlert2
    }
  });
}
      
      
      $(document).ready(function() {
  const cachedData = getCachedData();
  cachedEventsData = cachedData || [];
  
  if (cachedData) {
    renderData(cachedData);
  } else {
    lodingpagetoday();
  }
  
  updateCalendar(); // โหลดข้อมูลใหม่ทุกครั้งที่เปิดหน้า
});
      


        // อัปเดตปฏิทินเมื่อรีเฟรชหน้าจอ
        $(window).on('load', function() {
            updateCalendar();
        });
      
 // เก็บข้อมูลที่โหลดมาแล้ว เพื่อลดการโหลดซ้ำ
let cachedEventsData = [];

// โหลดข้อมูลรายการจองทั้งหมดเมื่อเริ่มต้น
function fetchAllEvents() {
 // lodingpagetoday();
    $.ajax({
        url: googleScriptUrlCalendar,
        dataType: 'json',
        success: function(data) {
            cachedEventsData = data; // เก็บข้อมูลไว้
         // Swal.close();
        },
        error: function() {
            console.error('❌ โหลดข้อมูลไม่สำเร็จ');
        }
    });
}

// ฟังก์ชันแสดงตัวเลือกเมื่อคลิกวันที่
function showDateOptions(selectedDate) {
    const selectedUTCDate = new Date(selectedDate + 'T00:00:00Z').toISOString().split('T')[0];
    const formattedDate = moment(selectedUTCDate).format('DD-MM-YYYY');
    
    const today = new Date().toISOString().split('T')[0]; // ได้วันที่ปัจจุบันในรูปแบบ YYYY-MM-DD
    const isPastDate = selectedUTCDate < today; // ตรวจสอบว่าเป็นวันย้อนหลังหรือไม่

    Swal.fire({
        title: `วันที่ ${formattedDate}`,
        text: 'คุณต้องการทำอะไร?',
        showConfirmButton: false,
        showCancelButton: false,
        showDenyButton: false,
        allowOutsideClick: false,
        footer: `
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="btn-view" class="swal2-confirm swal2-styled" style="background-color: blue;">ดูรายการจอง</button>
            ${isPastDate ? '' : '<button id="btn-book" class="swal2-confirm swal2-styled">จองรถ</button>'}
            <button id="btn-closs" class="swal2-confirm swal2-styled" style="background-color: gray;">ปิด</button>
          </div>
        `
    });

    setTimeout(() => {
        document.getElementById("btn-closs").addEventListener("click", () => Swal.close());
        if (!isPastDate) {
            document.getElementById("btn-book").addEventListener("click", () => {
                Swal.close();
                openAddDataModal(selectedUTCDate);
                $("#calendarpage").hide();
            });
        }
        document.getElementById("btn-view").addEventListener("click", () => {
            showAllEventsForDate(selectedUTCDate);
        });
    }, 100);
}


// ฟังก์ชันแสดงรายละเอียดรายการจอง
function showAllEventsForDate(selectedDate) {
    const selectedUTCDate = new Date(selectedDate + 'T00:00:00Z').toISOString().split('T')[0];

    // ค้นหาข้อมูลใน cache และกรองเฉพาะวันที่ที่ต้องการ
    let eventsForDate = cachedEventsData.filter(event => {
        const eventStartDate = moment(event.startday, 'YYYY-MM-DD').format('YYYY-MM-DD');
        const eventEndDate = moment(event.endday, 'YYYY-MM-DD').format('YYYY-MM-DD');
        return selectedUTCDate >= eventStartDate && selectedUTCDate <= eventEndDate;
    });

    // ถ้าไม่มีรายการจอง
    if (eventsForDate.length === 0) {
        Swal.fire({
            icon: 'info',
            title: 'ไม่มีรายการจองรถในวันนี้',
            confirmButtonText: 'ปิด'
        });
        return;
    }

    // เรียงลำดับตาม starttime
    eventsForDate.sort((a, b) => a.starttime.localeCompare(b.starttime));

    // แปลงวันที่เป็นรูปแบบไทย
    const date = new Date(selectedDate);
    const formattedDate = date.toLocaleDateString('th-TH', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    }).replace(/\//g, '-');

    // นับจำนวนคิวการจอง
    const totalBookings = eventsForDate.length;

    // สร้าง HTML แสดงข้อมูล
    let eventDetails = eventsForDate.map((event, index) => `
        <table class='w-full border border-gray-300 shadow-md rounded-lg text-left'>
            <thead class='bg-blue-500 text-white'>
                <tr><th colspan='2' class='text-center p-3 text-lg font-semibold'>คิวที่ ${index + 1}</th></tr>
            </thead>
            <tbody class='bg-white'>
                <tr class='border-b'><th class='p-2 bg-gray-100 text-left'>ชื่อ</th><td class='p-2 text-blue-600'>${event.namebook}</td></tr>
                <tr class='border-b'><th class='p-2 bg-gray-100 text-left'>รถ</th><td class='p-2 text-blue-600'>${event.title}</td></tr>
                <tr class='border-b'><th class='p-2 bg-gray-100 text-left'>ปลายทาง</th><td class='p-2 text-blue-600'>${event.loca}</td></tr>
                <tr class='border-b'><th class='p-2 bg-gray-100 text-left'>เวลา</th><td class='p-2 text-blue-600'>${event.starttime} - ${event.endtime} น.</td></tr>
                <tr class='border-b'><th class='p-2 bg-gray-100 text-left'>คนขับ</th><td class='p-2 text-blue-600'>${event.driver}</td></tr>
                <tr class='border-b'><th class='p-2 bg-gray-100 text-left'>อื่นๆ</th><td class='p-2 text-blue-600'>${event.other || '-'}</td></tr>
                <tr class='border-b'>
    <th class='p-2 bg-gray-100 text-left'>สถานะ</th>
    <td class='p-2 ${
        event.status === "กำลังใช้งาน" ? "text-red-600 font-bold" : 
        event.status === "ส่งคืน" ? "text-green-600 font-bold" : 
        "text-blue-600"
    }'>
        ${event.status}
    </td>
</tr>

                <tr><th class='p-2 bg-gray-100 text-left'>ผู้อนุมัติ</th><td class='p-2 text-blue-600'>${event.approve}</td></tr>
            </tbody>
        </table>
        <br>
    `).join('');

    // แสดงข้อมูลผ่าน Swal
    Swal.fire({
        title: `<h5 style="font-size: 18px;">วันที่ ${formattedDate} มีการจอง ${totalBookings} คิว</h5>`,
        html: eventDetails,
        confirmButtonText: 'ปิด',
        showCloseButton: true,
        customClass: {
            popup: 'swal-wide'
        }
    });
}


// โหลดข้อมูลตั้งแต่เปิดเว็บ
fetchAllEvents();

      
      
      
         

      
          // ฟังก์ชันเปิด Modal เพิ่มข้อมูล
function openAddDataModal(selectedDate = '') {
 const modal = document.getElementById('modal');
  const startDateInput = document.getElementById('namestartDate');
  const endDateInput = document.getElementById('nameendDate');
  startDateInput.value = selectedDate; // ตั้งค่าวันที่ในรูปแบบ UTC
  endDateInput.value = selectedDate; // ตั้งค่าวันที่ในรูปแบบ UTC
  modal.classList.remove('hidden'); // แสดง Modal
}




function closeModal() {
    document.getElementById("modal").classList.add("hidden");
  $("#calendarpage").hide();
  updateCalendar()
  //updateCalendar();
}

          // ฟังก์ชันปิด Modal แก้ไขข้อมูล
    function closeEventModal() {
      const modal = document.getElementById('modal');
      modal.classList.add('hidden');
    }

      
      
      
    
      
      
        function getCurrentDate() {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        return yyyy + '-' + mm + '-' + dd;
    }

    // กำหนดค่าเริ่มต้นให้ input[type="date"]
    var todayDate = getCurrentDate();
    document.getElementById('namestartDate').value = todayDate;
    document.getElementById('namestartDate').min = todayDate;

    document.getElementById('nameendDate').value = todayDate;
    document.getElementById('nameendDate').min = todayDate;


function booksubmitForm() {
  event.preventDefault();
  Swal.fire({
    position: 'center',
    title: '<h4>กำลังบันทึกข้อมูล...</h4>',
    showConfirmButton: false,
  });
  Swal.showLoading();

  // ดึงค่าจากฟอร์ม
  var namebook = document.getElementById('namebook').value;
  var namedep = document.getElementById('namedep').value;
  var namecar = document.getElementById('namecar').value;
  var nameloca = document.getElementById('nameloca').value;
  var namestartDate = document.getElementById('namestartDate').value;
  var nameendDate = document.getElementById('nameendDate').value;
  var namestartTime = document.getElementById('namestartTime').value;
  var nameendTime = document.getElementById('nameendTime').value;
  var namedrivestatus = document.getElementById('namedrivestatus').value;
  var nameother = document.getElementById('nameother').value;
  var referer = document.querySelector('input[name="referer"]').value;

  // ตรวจสอบข้อมูลที่จำเป็น
  if (namebook == "") {
    Swal.fire({
      position: 'center',
      icon: 'error',
      title: '<h4>กรุณากรอกชื่อสกุลท่าน</h4>',
      showConfirmButton: true,
      confirmButtonText: 'OK',
    });
    return;
  } else if (namedep == "") {
    Swal.fire({
      position: 'center',
      icon: 'error',
      title: '<h4>กรุณาเลือกแผนกของท่าน</h4>',
      showConfirmButton: true,
      confirmButtonText: 'OK',
    });
    return;
  } else if (namecar == "") {
    Swal.fire({
      position: 'center',
      icon: 'error',
      title: '<h4>กรุณาเลือกรถที่ท่านต้องการจอง</h4>',
      showConfirmButton: true,
      confirmButtonText: 'OK',
    });
    return;
  } else if (nameloca == "") {
    Swal.fire({
      position: 'center',
      icon: 'error',
      title: '<h4>กรุณาเลือกสถานที่ๆท่านไปติดต่อ</h4>',
      showConfirmButton: true,
      confirmButtonText: 'OK',
    });
    return;
  } else if (namestartDate == "") {
    Swal.fire({
      position: 'center',
      icon: 'error',
      title: '<h4>กรุณาเลือกวันที่ๆต้องการจอง</h4>',
      showConfirmButton: true,
      confirmButtonText: 'OK',
    });
    return;
  } else if (nameendDate == "") {
    Swal.fire({
      position: 'center',
      icon: 'error',
      title: '<h4>กรุณาเลือกวันที่เข้า</h4>',
      showConfirmButton: true,
      confirmButtonText: 'OK',
    });
    return;
  } else if (namestartTime == "") {
    Swal.fire({
      position: 'center',
      icon: 'error',
      title: '<h4>กรุณาเลือกเวลาออก</h4>',
      showConfirmButton: true,
      confirmButtonText: 'OK',
    });
    return;
  } else if (nameendTime == "") {
    Swal.fire({
      position: 'center',
      icon: 'error',
      title: '<h4>กรุณาเลือกเวลาเข้า</h4>',
      showConfirmButton: true,
      confirmButtonText: 'OK',
    });
    return;
  } else if (namestartDate > nameendDate) {
    Swal.fire({
      position: 'center',
      icon: 'error',
      title: '<h4>วันที่ออกต้องไม่เกินวันที่เข้า</h4>',
      showConfirmButton: true,
      confirmButtonText: 'OK',
    });
    return;
  } else if (namestartTime >= nameendTime) {
    Swal.fire({
      position: 'center',
      icon: 'error',
      title: '<h4>รูปแบบวันที่ไม่ถูกต้อง</h4>',
      showConfirmButton: true,
      confirmButtonText: 'OK',
    });
    return;
  } else if (namedrivestatus == "") {
    Swal.fire({
      position: 'center',
      icon: 'error',
      title: '<h4>กรุณาเลือกต้องการขับเองหรือพร้อมคนขับ</h4>',
      showConfirmButton: true,
      confirmButtonText: 'OK',
    });
    return;
  }

  // ถ้า namedrivestatus เป็น "ขับเอง" ให้ข้ามการตรวจสอบข้อมูลซ้ำ
  if (namedrivestatus !== "ขับเอง") {
    const duplicateEvent = cachedEventsData.find(event => {
      const eventStart = moment(event.startday + ' ' + event.starttime, 'YYYY-MM-DD HH:mm');
      const eventEnd = moment(event.endday + ' ' + event.endtime, 'YYYY-MM-DD HH:mm');
      const formStart = moment(namestartDate + ' ' + namestartTime, 'YYYY-MM-DD HH:mm');
      const formEnd = moment(nameendDate + ' ' + nameendTime, 'YYYY-MM-DD HH:mm');

      const isExcludedTitle = ['ฝากงาน', 'ติดรถไปติดต่องานด้วย'].includes(namecar);
      const isDriverMatch = (event.driver === "ภาคภูมิ เรือนมูล");
      const isOverlap = (formStart.isSameOrBefore(eventEnd) && formEnd.isSameOrAfter(eventStart));

      if (isExcludedTitle) {
        return false; // ถ้า title เป็นคำที่ไม่ต้องเช็คซ้ำ ให้ข้ามไปเลย
      }

      return isDriverMatch && isOverlap;
    });

    if (duplicateEvent) {
      Swal.fire({
        position: 'center',
        icon: 'error',
        title: '<h4 style="font-size: 18px;">พนักงานขับรถมีคิวขับ ' + duplicateEvent.title + ' ไป ' + duplicateEvent.loca + '<br> ออกเดินทางเวลา ' + duplicateEvent.starttime + '-' + duplicateEvent.endtime +' น.<br>กรุณาจองขับไปเองหรือจองช่วงเวลาอื่น'+ '</h4>',
        showConfirmButton: true,
        confirmButtonText: 'OK',
      });
      return;
    }
  }

  // หากไม่มีข้อมูลซ้ำ ส่งข้อมูลไปยัง Google Script
  var formData = new FormData(document.getElementById("bookmyForm"));
  formData.append('action', 'submitForm');
  formData.append('referer', referer);

  fetch(googleScriptUrlbook, {
    method: 'POST',
    body: formData
  })
    .then(response => response.text())
    .then(data => {
      if (data === "true") {
        // เคลียร์ฟอร์มหลังจากบันทึกข้อมูล
        document.getElementById('namecar').value = "";
        document.getElementById('nameloca').value = "";
        document.getElementById('namestartDate').value = "";
        document.getElementById('nameendDate').value = "";
        document.getElementById('namestartTime').value = "";
        document.getElementById('nameendTime').value = "";
        document.getElementById('namedrivestatus').value = "";
        document.getElementById('nameother').value = "";

        Swal.fire({
          position: 'center',
          icon: 'success',
          title: '<h4>บันทึกข้อมูลสำเร็จ</h4>',
          showConfirmButton: false,
          timer: 1500,
        }).then(() => {
          updateCalendar();
          closeModal();
          // location.reload();
        });
      } else if (data === "Unauthorized Request: Invalid Referer") {
        // แสดง alert หาก referer ไม่ถูกต้อง
        Swal.fire({
          position: 'center',
          icon: 'error',
          title: '<h4>การร้องขอถูกปฏิเสธ เนื่องจาก Referer ไม่ถูกต้อง</h4>',
          showConfirmButton: true,
          confirmButtonText: 'OK',
        });
      } else {
        Swal.fire({
          position: 'center',
          icon: 'error',
          title: '<h4>มีการจองรถคันนี้วันที่และช่วงเวลานี้แล้ว</h4>',
          showConfirmButton: true,
          confirmButtonText: 'OK',
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      Swal.fire({
        position: 'center',
        icon: 'error',
        title: '<h4>เกิดข้อผิดพลาดในการเชื่อมต่อ</h4>',
        showConfirmButton: true,
        confirmButtonText: 'OK',
      });
    });
}
      
      
      
    </script>
 

   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
</html>
